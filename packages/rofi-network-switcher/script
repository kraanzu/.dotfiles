#!/usr/bin/env bash
# Build maps of display->actual names
declare -A name_map
while IFS=: read -r name type; do
    [[ "$type" =~ loopback|bridge ]] && continue

    device=$(nmcli -t -f connection.interface-name connection show "$name" 2>/dev/null | cut -d: -f2)
    if [ -n "$device" ]; then
        vendor=$(nmcli -t -f GENERAL.VENDOR device show "$device" 2>/dev/null | cut -d: -f2)
        if [ -n "$vendor" ]; then
            display="$vendor ($name)"
        else
            display="$name"
        fi
    else
        display="$name"
    fi

    name_map["$display"]="$name"
done < <(nmcli -g NAME,TYPE connection show)

# Show in rofi
choice=$(printf "%s\n" "${!name_map[@]}" | rofi -dmenu -p "Select Network")
if [ -n "$choice" ]; then
    connection="${name_map[$choice]}"

    # Set lower priority for others
    for conn in "${name_map[@]}"; do
        if [ "$conn" != "$connection" ]; then
            nmcli connection modify "$conn" ipv4.route-metric 600
            nmcli connection up "$conn" 2>/dev/null
        fi
    done

    # Set higher priority for selected
    nmcli connection modify "$connection" ipv4.route-metric 100
    nmcli connection up "$connection"
fi
